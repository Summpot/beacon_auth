name = "beaconauth"
compatibility_date = "2025-12-18"

# Entry point generated by `worker-build`.
main = "crates/beacon-worker/build/worker/shim.mjs"

# The `main` shim lives under `build/worker/`, but worker-build emits the WASM file at `build/*.wasm`.
# Set `base_dir` so module `rules` globs match the generated WASM.
base_dir = "build"

# Build the Rust Worker via worker-build (workers-rs) and upload the generated module bundle.
[build]
command = "cargo install -q --path ./thirdparty/workers-rs/worker-build && worker-build --release crates/beacon-worker && pnpm build"

# Ensure WASM artifacts generated by `worker-build` are uploaded alongside the JS module graph.
[[rules]]
type = "CompiledWasm"
globs = ["**/*.wasm", "**/*.wasm?module"]
fallthrough = false

[assets]
# The frontend build output is copied here during CI (and can be generated locally).
directory = "./dist"
# Optional binding name (useful for manual fetching); we mainly rely on routing.
binding = "ASSETS"
# SPA fallback: unknown paths (e.g. /login) return index.html.
not_found_handling = "single-page-application"
# Serve API routes from the Rust Worker and delegate other requests to static assets.
# NOTE: Wrangler expects a boolean here.
run_worker_first = true

[[d1_databases]]
binding = "DB"
database_name = "beacon-auth"
database_id = "REPLACE_WITH_D1_DATABASE_ID"

[vars]
BASE_URL = ""
JWT_KID = "beacon-auth-key-1"
ACCESS_TOKEN_EXPIRATION = "900"
REFRESH_TOKEN_EXPIRATION = "2592000"
JWT_EXPIRATION = "3600"
